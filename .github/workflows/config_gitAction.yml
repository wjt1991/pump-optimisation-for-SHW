name: Run GitAction App

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"

permissions:
  contents: write



jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: requirements.txt

      - name: Install dependencies
        run: |
          python -V
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt
          python -m pip freeze | sort

      - name: Run app_api.py
        env:
          TZ: Australia/Sydney
        run: |
          mkdir -p output
          python app_api.py
          echo "Output files:"
          ls -la output || true

      # out output to repo after every run
      - name: Commit latest output back to repo (always)
        if: github.event_name != 'pull_request'
        env:
          TZ: Australia/Sydney
        run: |
          set -e
          mkdir -p data/latest
          rm -rf data/latest/*
          if [ -d "output" ]; then
            cp -r output/* data/latest/ || true
          fi

          {
            echo "run_id=${{ github.run_id }}"
            echo "run_number=${{ github.run_number }}"
            echo "workflow=${{ github.workflow }}"
            echo "ref=${{ github.ref }}"
            echo "sha=${{ github.sha }}"
            echo "time_sydney=$(date -Iseconds)"
          } > data/latest/_meta.txt

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add data/latest
          # Always commit (meta changes every run)
          git commit -m "Update latest output (run ${{ github.run_number }})"
          git push

      # keep artifact as well
      - name: Upload output artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: app-api-output
          path: output/
          if-no-files-found: warn
          retention-days: 14